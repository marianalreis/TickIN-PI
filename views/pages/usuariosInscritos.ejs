<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Usuários Inscritos - TickIN</title>
    <link rel="stylesheet" href="/css/registered-users.css" />
    <link rel="stylesheet" href="/css/header.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  </head>
  <body>
    <%- include('../partials/header') %>

    <div class="container">
      <h1 class="page-title">Usuários Inscritos</h1>

      <div class="event-info">
        <div class="event-header">
          <img src="<%= event.imagem || '/assets/tickIN.png' %>" alt="<%= event.titulo %>" class="event-image">
          <div class="event-details">
            <h2><%= event.titulo %></h2>
            <div class="event-meta">
              <div class="meta-item">
                <img src="/assets/calendar.png" alt="Data" class="meta-icon">
                <span><%= new Date(event.data).toLocaleDateString('pt-BR') %></span>
              </div>
              <div class="meta-item">
                <img src="/assets/clock.png" alt="Horário" class="meta-icon">
                <span><%= event.horario %></span>
              </div>
              <div class="meta-item">
                <img src="/assets/location.png" alt="Local" class="meta-icon">
                <span><%= event.local %></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <% if (inscricoes && inscricoes.length > 0) { %>
        <div class="registrations-table">
          <div class="table-header">
            <div>Usuário</div>
            <div>Data de Inscrição</div>
            <div>Status</div>
            <div>Presença</div>
            <div>Ação</div>
          </div>
          <% inscricoes.forEach(inscricao => { %>
            <div class="table-row">
              <div class="user-info">
                <img src="/assets/user.png" alt="<%= inscricao.usuario_nome %>" class="user-avatar">
                <div>
                  <div class="user-name"><%= inscricao.usuario_nome %></div>
                  <div class="user-email"><%= inscricao.email %></div>
                </div>
              </div>
              <div><%= new Date(inscricao.data_inscricao).toLocaleDateString('pt-BR') %></div>
              <div>
                <span class="status-badge status-<%= inscricao.status.toLowerCase() %>">
                  <%= inscricao.status %>
                </span>
              </div>
              <div>
                <% if (inscricao.status === 'Confirmado') { %>
                  <label class="presence-toggle">
                    <input type="checkbox" onchange="markPresence('<%= inscricao.inscricao_id %>', this.checked)" 
                      <%= inscricao.presente ? 'checked' : '' %>>
                    <span class="slider"></span>
                  </label>
                <% } else { %>
                  <span>N/A</span>
                <% } %>
              </div>
              <div>
                <a href="mailto:<%= inscricao.email %>" class="action-button contact-button">
                  Contatar
                </a>
              </div>
            </div>
          <% }); %>
        </div>

        <div class="reminder-section">
          <h2>Enviar Lembrete</h2>
          <form id="reminderForm" onsubmit="sendReminder(event)">
            <div class="form-group">
              <label for="reminderUsers">Selecionar Usuários</label>
              <select id="reminderUsers" multiple>
                <% inscricoes.filter(insc => insc.status === 'Pendente').forEach(insc => { %>
                  <option value="<%= insc.email %>"><%= insc.usuario_nome %> (<%= insc.email %>)</option>
                <% }); %>
              </select>
            </div>
            
            <div class="form-group">
              <label for="reminderMessage">Mensagem</label>
              <textarea id="reminderMessage" placeholder="Digite sua mensagem..."></textarea>
            </div>
            
            <button type="submit" class="submit-button">Enviar Lembrete</button>
          </form>
        </div>
      <% } else { %>
        <div class="empty-state">
          <img src="/assets/tickIN.png" alt="Sem inscrições">
          <h2>Nenhuma inscrição ainda</h2>
          <p>Compartilhe seu evento para atrair participantes!</p>
        </div>
      <% } %>
    </div>

    <script>
      async function markPresence(inscricaoId, isPresent) {
        try {
          const response = await fetch(`/api/inscricoes/${inscricaoId}/presenca`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ presente: isPresent })
          });

          if (!response.ok) {
            throw new Error('Erro ao atualizar presença');
          }

          const data = await response.json();
          alert(data.message || 'Presença atualizada com sucesso!');
        } catch (error) {
          console.error('Erro:', error);
          alert('Erro ao atualizar presença');
        }
      }

      async function sendReminder(event) {
        event.preventDefault();
        
        const selectedUsers = Array.from(document.getElementById('reminderUsers').selectedOptions)
          .map(option => option.value);
        const message = document.getElementById('reminderMessage').value;
        
        if (selectedUsers.length === 0) {
          alert('Selecione pelo menos um usuário');
          return;
        }
        
        if (!message) {
          alert('Digite uma mensagem');
          return;
        }
        
        try {
          const response = await fetch('/api/eventos/reminder', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              users: selectedUsers,
              message: message
            })
          });

          if (!response.ok) {
            throw new Error('Erro ao enviar lembrete');
          }

          alert('Lembrete enviado com sucesso!');
          document.getElementById('reminderMessage').value = '';
          document.getElementById('reminderUsers').selectedIndex = -1;
        } catch (error) {
          console.error('Erro:', error);
          alert('Erro ao enviar lembrete');
        }
      }
    </script>
  </body>
</html>
